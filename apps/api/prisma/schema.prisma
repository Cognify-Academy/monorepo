generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "darwin-arm64", "linux-arm64-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// / üßë‚Äçüè´ USERS ////
model User {
  id             String              @id @default(uuid())
  email          String              @unique
  username       String              @unique
  name           String
  password       String
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now()) @updatedAt
  instructor     CourseInstructor[]
  coursesCreated Course[]
  enrollments    Enrollment[]
  lessonProgress LessonProgress[]
  media          Media[]
  refreshTokens  RefreshToken[]
  roles          UserRole[]
  certificates   IssuedCertificate[]

  @@map("users")
}

model UserRole {
  id        String   @id @unique @default(cuid())
  userId    String
  role      Role
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@map("user_roles")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  createdAt DateTime @default(now())
  expiresAt DateTime
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

/// / üìö CURRICULUM ////
model Course {
  id             String              @id @default(cuid())
  title          String
  description    String
  published      Boolean             @default(false)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @default(now()) @updatedAt
  userId         String
  slug           String              @unique
  conceptCourses ConceptCourse[]
  instructors    CourseInstructor[]
  user           User                @relation(fields: [userId], references: [id])
  enrollments    Enrollment[]
  sections       Section[]
  certificates   IssuedCertificate[]

  @@map("courses")
}

model CourseInstructor {
  id         String   @id @default(cuid())
  courseId   String
  userId     String
  createdAt  DateTime @default(now())
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  instructor User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([courseId, userId])
  @@map("course_instructors")
}

model Section {
  id             String           @id @default(cuid())
  title          String
  description    String
  courseId       String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now()) @updatedAt
  order          Int              @default(0)
  ConceptSection ConceptSection[]
  lessons        Lesson[]
  course         Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("sections")
}

model Lesson {
  id             String           @id @default(cuid())
  title          String           @unique
  description    String
  sectionId      String
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @default(now()) @updatedAt
  order          Int              @default(0)
  content        Json
  ConceptLesson  ConceptLesson[]
  lessonProgress LessonProgress[]
  section        Section          @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  media          Media[]

  @@map("lessons")
}

/// / üéì ENROLLMENT ////
model Enrollment {
  id        String   @id @default(cuid())
  userId    String
  courseId  String
  completed Boolean  @default(false)
  createdAt DateTime @default(now())
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("enrollments")
}

model LessonProgress {
  id          String    @id @default(cuid())
  userId      String
  lessonId    String
  completed   Boolean   @default(false)
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("lesson_progress")
}

/// / üìñ CONCEPT META ////
model Concept {
  id            String            @id @default(cuid())
  name          String            @unique
  description   String
  importance    Int
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @default(now()) @updatedAt
  slug          String            @unique
  courses       ConceptCourse[]
  lessons       ConceptLesson[]
  conceptSource ConceptRelation[] @relation("conceptSource")
  conceptTarget ConceptRelation[] @relation("conceptTarget")
  sections      ConceptSection[]

  @@map("concepts")
}

model ConceptRelation {
  id              String   @id @default(cuid())
  description     String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt
  conceptSourceId String
  conceptTargetId String
  weighting       Float?
  conceptSource   Concept  @relation("conceptSource", fields: [conceptSourceId], references: [id], onDelete: Cascade)
  conceptTarget   Concept  @relation("conceptTarget", fields: [conceptTargetId], references: [id], onDelete: Cascade)

  @@unique([conceptSourceId, conceptTargetId], name: "unique_edge")
  @@map("concept_relations")
}

model ConceptCourse {
  id        String   @id @default(cuid())
  conceptId String
  courseId  String
  createdAt DateTime @default(now())
  concept   Concept  @relation(fields: [conceptId], references: [id], onDelete: Cascade)
  course    Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([conceptId, courseId])
  @@map("concept_courses")
}

model ConceptSection {
  id        String   @id @default(cuid())
  conceptId String
  sectionId String
  createdAt DateTime @default(now())
  concept   Concept  @relation(fields: [conceptId], references: [id], onDelete: Cascade)
  section   Section  @relation(fields: [sectionId], references: [id], onDelete: Cascade)

  @@unique([conceptId, sectionId])
  @@map("concept_sections")
}

model ConceptLesson {
  id        String   @id @default(cuid())
  conceptId String
  lessonId  String
  createdAt DateTime @default(now())
  concept   Concept  @relation(fields: [conceptId], references: [id], onDelete: Cascade)
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([conceptId, lessonId])
  @@map("concept_lessons")
}

model Media {
  id          String   @id @default(cuid())
  title       String
  description String
  mediaType   String
  content     String?
  url         String?
  notes       String?
  transcript  String?
  lessonId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  metadata    Json?
  userId      String
  audience    Audience @default(BEGINNERS)
  lesson      Lesson?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("media")
}

/// / üìû CONTACT ////
model Contact {
  id        String        @id @default(cuid())
  name      String
  email     String
  subject   String
  message   String
  status    ContactStatus @default(PENDING)
  createdAt DateTime      @default(now())
  updatedAt DateTime      @default(now()) @updatedAt

  @@map("contacts")
}

enum Role {
  INSTRUCTOR
  STUDENT
  ADMIN
}

/// / üé• MEDIA ////
enum Audience {
  BEGINNERS
  INTERMEDIATE
  ADVANCED
}

enum ContactStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  ARCHIVED
}

enum Column {
  BACKLOG
  TODO
  IN_PROGRESS
  COMPLETE
}

//// SSIDs/Certificates ////

model IssuedCertificate {
  id         String   @id @default(uuid())
  userId     String // üîó relational link to your internal user
  studentDid String // üåê DID string for decentralized verification
  issuerDid  String
  courseId   String
  vcJson     Json
  vcHash     String
  nftAddress String?
  createdAt  DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@map("issued_certificates")
}
